From 7763dcfc6abd56c9e19eca7e07491d45af11c715 Mon Sep 17 00:00:00 2001
From: He Junyan <junyan.he@intel.com>
Date: Sat, 7 Sep 2024 10:45:09 +0800
Subject: [PATCH 089/117] h264bitwriter: Add check for data size to avoid
 overflow

Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/7547>
---
 gst-libs/gst/codecparsers/gsth264bitwriter.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/gst-libs/gst/codecparsers/gsth264bitwriter.c b/gst-libs/gst/codecparsers/gsth264bitwriter.c
index 54e1bf9fd..ca9cec509 100644
--- a/gst-libs/gst/codecparsers/gsth264bitwriter.c
+++ b/gst-libs/gst/codecparsers/gsth264bitwriter.c
@@ -1592,6 +1592,7 @@ gst_h264_bit_writer_convert_to_nal (guint nal_prefix_size, gboolean packetized,
       GST_H264_BIT_WRITER_ERROR);
   g_return_val_if_fail (raw_data != NULL, GST_H264_BIT_WRITER_ERROR);
   g_return_val_if_fail (raw_size > 0, GST_H264_BIT_WRITER_ERROR);
+  g_return_val_if_fail (raw_size / 8 <= G_MAXUINT, GST_H264_BIT_WRITER_ERROR);
   g_return_val_if_fail (nal_data != NULL, GST_H264_BIT_WRITER_ERROR);
   g_return_val_if_fail (nal_size != NULL, GST_H264_BIT_WRITER_ERROR);
   g_return_val_if_fail (*nal_size > 0, GST_H264_BIT_WRITER_ERROR);
@@ -1619,7 +1620,7 @@ gst_h264_bit_writer_convert_to_nal (guint nal_prefix_size, gboolean packetized,
 
   nal_writer_init (&nw, nal_prefix_size, packetized);
 
-  if (!nal_writer_put_bytes (&nw, raw_data, raw_size / 8))
+  if (!nal_writer_put_bytes (&nw, raw_data, (guint) (raw_size / 8)))
     goto error;
 
   if (raw_size % 8) {
-- 
2.43.0

