From 2ade887b359da8d098b702c8a4165041a7755ffd Mon Sep 17 00:00:00 2001
From: "Abd Razak, Muhammad Azizul Hazim"
 <muhammad.azizul.hazim.abd.razak@intel.com>
Date: Wed, 2 Jul 2025 15:10:57 +0800
Subject: [PATCH] msdkav1enc: Add intrabc and palette for scc encode

Signed-off-by: Abd Razak, Muhammad Azizul Hazim <muhammad.azizul.hazim.abd.razak@intel.com>
---
 sys/msdk/gstmsdkav1enc.c | 47 ++++++++++++++++++++++++++++++++++++++++
 sys/msdk/gstmsdkav1enc.h |  3 +++
 2 files changed, 50 insertions(+)

diff --git a/sys/msdk/gstmsdkav1enc.c b/sys/msdk/gstmsdkav1enc.c
index 2343360ca..f06367636 100644
--- a/sys/msdk/gstmsdkav1enc.c
+++ b/sys/msdk/gstmsdkav1enc.c
@@ -71,12 +71,16 @@ enum
   PROP_TILE_COL,
   PROP_B_PYRAMID,
   PROP_P_PYRAMID,
+  PROP_PALETTE,
+  PROP_INTRABC,
 };
 
 #define PROP_TILE_ROW_DEFAULT           1
 #define PROP_TILE_COL_DEFAULT           1
 #define PROP_B_PYRAMID_DEFAULT          MFX_B_REF_UNKNOWN
 #define PROP_P_PYRAMID_DEFAULT          MFX_P_REF_DEFAULT
+#define PROP_PALETTE_DEFAULT            FALSE
+#define PROP_INTRABC_DEFAULT            FALSE
 
 /* *INDENT-OFF* */
 static const gchar *doc_sink_caps_str =
@@ -204,6 +208,21 @@ gst_msdkav1enc_configure (GstMsdkEnc * encoder)
   gst_msdkenc_add_extra_param (encoder,
       (mfxExtBuffer *) & av1enc->ext_av1_tile_param);
 
+  /* Attach extended buffers & params only if atleast intrabc or palette is enabled */
+  if (av1enc->palette || av1enc->intrabc) {
+    memset (&av1enc->ext_av1_scc_param, 0, sizeof (av1enc->ext_av1_scc_param));
+    av1enc->ext_av1_scc_param.Header.BufferId =
+        MFX_EXTBUFF_AV1_SCREEN_CONTENT_TOOLS;
+    av1enc->ext_av1_scc_param.Header.BufferSz =
+        sizeof (av1enc->ext_av1_scc_param);
+    av1enc->ext_av1_scc_param.Palette =
+        av1enc->palette ? MFX_CODINGOPTION_ON : MFX_CODINGOPTION_OFF;
+    av1enc->ext_av1_scc_param.IntraBlockCopy =
+        av1enc->intrabc ? MFX_CODINGOPTION_ON : MFX_CODINGOPTION_OFF;
+    gst_msdkenc_add_extra_param (encoder,
+        (mfxExtBuffer *) & av1enc->ext_av1_scc_param);
+  }
+
   return TRUE;
 }
 
@@ -274,6 +293,14 @@ gst_msdkav1enc_set_property (GObject * object, guint prop_id,
       thiz->p_pyramid = g_value_get_boolean (value);
       break;
 
+    case PROP_PALETTE:
+      thiz->palette = g_value_get_boolean (value);
+      break;
+
+    case PROP_INTRABC:
+      thiz->intrabc = g_value_get_boolean (value);
+      break;
+
     default:
       G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
       break;
@@ -309,6 +336,14 @@ gst_msdkav1enc_get_property (GObject * object, guint prop_id, GValue * value,
       g_value_set_boolean (value, thiz->p_pyramid);
       break;
 
+    case PROP_PALETTE:
+      g_value_set_boolean (value, thiz->palette);
+      break;
+
+    case PROP_INTRABC:
+      g_value_set_boolean (value, thiz->intrabc);
+      break;
+
     default:
       G_OBJECT_WARN_INVALID_PROPERTY_ID (object, prop_id, pspec);
       break;
@@ -349,6 +384,16 @@ _msdkav1enc_install_properties (GObjectClass * gobject_class,
       g_param_spec_boolean ("p-pyramid", "P-pyramid",
           "Enable P-Pyramid Reference structure", PROP_P_PYRAMID_DEFAULT,
           G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
+  g_object_class_install_property (gobject_class, PROP_PALETTE,
+      g_param_spec_boolean ("palette", "Palette Mode",
+          "Enable Palette mode for Screen Content Coding, only available on supported hardware",
+          PROP_PALETTE_DEFAULT, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
+
+  g_object_class_install_property (gobject_class, PROP_INTRABC,
+      g_param_spec_boolean ("intrabc", "Intra Block Copy",
+          "Enable Intra Block Copy for Screen Content Coding, only available on supported hardware",
+          PROP_INTRABC_DEFAULT, G_PARAM_READWRITE | G_PARAM_STATIC_STRINGS));
 }
 
 static void
@@ -401,6 +446,8 @@ gst_msdkav1enc_init (GTypeInstance * instance, gpointer g_class)
   thiz->num_tile_cols = PROP_TILE_COL_DEFAULT;
   thiz->b_pyramid = PROP_B_PYRAMID_DEFAULT;
   thiz->p_pyramid = PROP_P_PYRAMID_DEFAULT;
+  thiz->palette = PROP_PALETTE_DEFAULT;
+  thiz->intrabc = PROP_INTRABC_DEFAULT;
 }
 
 gboolean
diff --git a/sys/msdk/gstmsdkav1enc.h b/sys/msdk/gstmsdkav1enc.h
index b5f324c06..77cfe61c8 100644
--- a/sys/msdk/gstmsdkav1enc.h
+++ b/sys/msdk/gstmsdkav1enc.h
@@ -49,10 +49,13 @@ struct _GstMsdkAV1Enc
   gushort num_tile_cols;
   guint b_pyramid;
   guint p_pyramid;
+  gboolean palette;
+  gboolean intrabc;
 
   mfxExtAV1BitstreamParam ext_av1_bs_param;
   mfxExtAV1ResolutionParam ext_av1_res_param;
   mfxExtAV1TileParam ext_av1_tile_param;
+  mfxExtAV1ScreenContentTools ext_av1_scc_param;
 };
 
 struct _GstMsdkAV1EncClass
-- 
2.43.0

