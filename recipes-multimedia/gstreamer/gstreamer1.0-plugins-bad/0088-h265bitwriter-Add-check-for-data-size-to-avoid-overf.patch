From 40fd9defe19c7e29c9f9c08ca63f2059c3eebe05 Mon Sep 17 00:00:00 2001
From: He Junyan <junyan.he@intel.com>
Date: Sat, 7 Sep 2024 10:26:22 +0800
Subject: [PATCH 088/117] h265bitwriter: Add check for data size to avoid
 overflow

Part-of: <https://gitlab.freedesktop.org/gstreamer/gstreamer/-/merge_requests/7547>
---
 gst-libs/gst/codecparsers/gsth265bitwriter.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/gst-libs/gst/codecparsers/gsth265bitwriter.c b/gst-libs/gst/codecparsers/gsth265bitwriter.c
index 5221a4ffc..767cc7c86 100644
--- a/gst-libs/gst/codecparsers/gsth265bitwriter.c
+++ b/gst-libs/gst/codecparsers/gsth265bitwriter.c
@@ -2261,6 +2261,7 @@ gst_h265_bit_writer_convert_to_nal (guint nal_prefix_size,
       GST_H265_BIT_WRITER_ERROR);
   g_return_val_if_fail (raw_data != NULL, GST_H265_BIT_WRITER_ERROR);
   g_return_val_if_fail (raw_size > 0, GST_H265_BIT_WRITER_ERROR);
+  g_return_val_if_fail (raw_size / 8 <= G_MAXUINT, GST_H265_BIT_WRITER_ERROR);
   g_return_val_if_fail (nal_data != NULL, GST_H265_BIT_WRITER_ERROR);
   g_return_val_if_fail (nal_size != NULL, GST_H265_BIT_WRITER_ERROR);
   g_return_val_if_fail (*nal_size > 0, GST_H265_BIT_WRITER_ERROR);
@@ -2288,7 +2289,7 @@ gst_h265_bit_writer_convert_to_nal (guint nal_prefix_size,
 
   nal_writer_init (&nw, nal_prefix_size, packetized);
 
-  if (!nal_writer_put_bytes (&nw, raw_data, raw_size / 8))
+  if (!nal_writer_put_bytes (&nw, raw_data, (guint) (raw_size / 8)))
     goto error;
 
   if (raw_size % 8) {
-- 
2.43.0

